{
  i18n: false,
  type: "tabs",
  items: {
    overview: {
      type: "panel",
      label: "Übersicht",
      items: {
        _intro: {
          type: "staticText",
          text: "Dieser Adapter verwaltet WireGuard auf dem ioBroker‑Host und setzt eine strikte Firewall am WG‑Interface: erlaubt werden nur die ausgewählten TCP‑Ports (z. B. 8081/8082) zum Host. Forwarding ins LAN wird blockiert (keine Netzwerk‑Durchleitung)."
        },

        _note1: {
          type: "staticText",
          text: "Ampel/Status: In der Instanzenliste wird \"Verbunden mit Gerät oder Dienst\" grün, sobald das WireGuard‑Interface aktiv ist (wg‑quick up)."
        },

        _health: {
          type: "textSendTo",
          label: "Ampel / Status (empfohlen)",
          command: "healthOverview",
          onLoaded: true,
          copyToClipboard: false,
          container: "html"
        },

        _routerNote: {
          type: "staticText",
          text: "Hinweis Internet-Zugriff: Für eingehende WireGuard‑Verbindungen wird in den meisten Heimnetzen eine UDP‑Portweiterleitung (z. B. 51820) im Router benötigt. Ohne Router‑Änderung funktioniert es nur, wenn der Host direkt öffentlich erreichbar ist (öffentliche IPv4/IPv6) oder über einen externen Hub/VPS (Reverse‑VPN)."
        }
      }
    },

    server: {
      type: "panel",
      label: "Server",
      items: {
        _info1: {
          type: "staticText",
          text: "Schrittfolge (typisch): 1) Server‑Konfiguration erstellen/aktualisieren → 2) Firewall anwenden → 3) VPN starten."
        },

        enabled: { type: "checkbox", label: "Aktivieren (Auto‑Start)", sm: 6, md: 4 },
        ifaceName: { type: "text", label: "WireGuard Interface‑Name", sm: 6, md: 4, placeholder: "wg-nexowattvpn" },
        listenPort: { type: "port", label: "WireGuard Port (UDP)", sm: 6, md: 4 },

        vpnCidr: { type: "text", label: "VPN Netzwerk (CIDR)", sm: 6, md: 4, placeholder: "10.80.80.0/24" },
        hostVpnIp: { type: "text", label: "Host VPN Adresse (CIDR)", sm: 6, md: 4, placeholder: "10.80.80.1/24" },
        endpointHost: { type: "text", label: "Endpoint Hostname/IP (öffentlich)", sm: 6, md: 4, placeholder: "my.dyndns.org" },

        dns: { type: "text", label: "DNS für Clients (optional)", sm: 6, md: 4, placeholder: "192.168.1.1" },
        persistentKeepalive: { type: "number", label: "PersistentKeepalive (Client)", sm: 6, md: 4, min: 0, max: 300, step: 1 },
        usePsk: { type: "checkbox", label: "PSK verwenden (empfohlen)", sm: 6, md: 4 },

        allowedPorts: { type: "text", label: "Erlaubte TCP‑Ports über VPN", sm: 6, md: 6, placeholder: "8081,8082" },
        _firewallBackend: { type: "staticText", text: "Firewall‑Backend: nftables (nft). iptables wird nicht verwendet.", sm: 12, md: 8 },

        _divider1: { type: "divider" },

        _ensure: { type: "sendTo", label: "Server‑Konfiguration erstellen/aktualisieren", command: "ensureServer", showProcess: true, timeout: 60000 },
        _fw: { type: "sendTo", label: "Firewall‑Regeln anwenden (WG‑Interface)", command: "applyFirewall", showProcess: true, timeout: 60000 },
        _up: { type: "sendTo", label: "VPN starten (wg‑quick up)", command: "up", showProcess: true, timeout: 60000 },

        _down: { type: "sendTo", label: "VPN stoppen (wg‑quick down)", command: "down", showProcess: true, timeout: 60000 },
        _rmfw: { type: "sendTo", label: "Firewall‑Regeln entfernen", command: "removeFirewall", showProcess: true, timeout: 60000 },

        _dividerStatus: { type: "divider" },

        _serverKey: { type: "textSendTo", label: "Server Public Key", command: "getServerPublicKey", onLoaded: true, copyToClipboard: true, container: "text" },
        _status: { type: "textSendTo", label: "Status (wg show)", command: "status", onLoaded: false, copyToClipboard: true, container: "text" },
        _fwStatus: { type: "textSendTo", label: "Firewall‑Status (nft)", command: "firewallStatus", onLoaded: true, copyToClipboard: true, container: "text" },

        _dividerBind: { type: "divider" },

        _bindInfo: {
          type: "staticText",
          text: "Optional (Hardening): Wenn ioBroker Admin/Web/Vis NUR über VPN erreichbar sein soll, binde diese Dienste an die WireGuard‑Host‑Adresse (hostVpnIp ohne /24), statt an 0.0.0.0. Der Adapter ändert andere Instanzen nicht automatisch, kann aber unten prüfen, wie sie aktuell gebunden sind."
        },

        _bindingCheck: {
          type: "textSendTo",
          label: "Bind/Exposure‑Check (Ports)",
          command: "bindingCheck",
          onLoaded: true,
          container: "html",
          copyToClipboard: false,
          alsoDependsOn: ["allowedPorts", "hostVpnIp"]
        }
      }
    },

    install: {
      type: "panel",
      label: "Installieren",
      items: {
        _intro: {
          type: "staticText",
          text: "Dieser Bereich hilft bei der System‑Einrichtung. Wichtig: Der Adapter läuft als Benutzer 'iobroker' und benötigt für System‑Aktionen einmalig eine minimale sudo‑Freigabe (NOPASSWD) für den Root‑Helper."
        },

        serviceUser: { type: "text", label: "ioBroker Service‑Benutzer (sudoers)", sm: 6, md: 4, placeholder: "iobroker" },

        _prereq: {
          type: "textSendTo",
          label: "Voraussetzungen prüfen (wg/nft)",
          command: "prereqCheck",
          onLoaded: true,
          copyToClipboard: true,
          container: "text"
        },

        _sudo: {
          type: "textSendTo",
          label: "sudo‑Freigabe prüfen (sudo -n)",
          command: "sudoCheck",
          onLoaded: true,
          copyToClipboard: true,
          container: "text"
        },

        _bootstrap: {
          type: "textSendTo",
          label: "Bootstrap‑Befehl (1× im Terminal als root ausführen)",
          command: "bootstrapCommand",
          onLoaded: true,
          copyToClipboard: true,
          container: "text",
          alsoDependsOn: ["serviceUser"]
        },

        _install: {
          type: "sendTo",
          label: "Voraussetzungen installieren/reparieren (apt)",
          command: "installPrereqs",
          showProcess: true,
          timeout: 1200000,
          confirm: "Das führt apt-get update/install aus und aktiviert nftables. Fortfahren?"
        },

        _fullSetup: {
          type: "sendTo",
          label: "One‑Click Full‑Setup (Prereqs + Server + Firewall + Start)",
          command: "fullSetup",
          showProcess: true,
          timeout: 1200000,
          confirm: "Das installiert/prüft Voraussetzungen, erstellt/aktualisiert die WG‑Config, setzt Firewall‑Regeln und startet die VPN. Fortfahren?"
        }
      }
    },

    profiles: {
      type: "panel",
      label: "Profile",
      items: {
        _info2: {
          type: "staticText",
          text: "Hier erzeugst du Client‑Profile für die WireGuard‑App. Standardmäßig ist AllowedIPs in der Client‑Config auf die Host‑VPN‑IP (/32) beschränkt – damit gibt es keinen Zugriff ins LAN."
        },

        _profileName: { type: "text", label: "Profilname", sm: 6, md: 4, placeholder: "phone-max" },
        _profilePassword: { type: "password", label: "Passwort (optional → PSK abgeleitet)", sm: 6, md: 4, placeholder: "leer lassen = zufällige PSK" },

        _createBtn: {
          type: "sendTo",
          label: "Profil erstellen/rotieren + Client‑Config + QR",
          command: "createProfile",
          showProcess: true,
          timeout: 60000,
          confirm: "Das fügt einen Peer in /etc/wireguard/<iface>.conf hinzu bzw. rotiert ihn. Fortfahren?",
          jsonData: "{\"profileName\":\"${data._profileName}\",\"password\":\"${data._profilePassword}\"}",
          alsoDependsOn: ["_profileName", "_profilePassword"]
        },

        _clearOutput: {
          type: "sendTo",
          label: "Letzte Ausgabe löschen (empfohlen)",
          command: "clearLastOutput",
          showProcess: false
        },

        _lastOutput: {
          type: "state",
          label: "Letzte erzeugte Ausgabe (Client‑Config + QR)",
          oid: "profiles.lastGeneratedHtml",
          control: "html",
          xs: 12,
          newLine: true
        },

        _divider2: { type: "divider" },

        _listProfiles: {
          type: "textSendTo",
          label: "Profile auflisten (aus Konfiguration)",
          command: "listProfiles",
          onLoaded: false,
          copyToClipboard: true,
          container: "text"
        },

        _revokeProfile: {
          type: "selectSendTo",
          label: "Profil auswählen (zum Widerruf)",
          command: "profileOptions",
          noTranslation: true,
          manual: true,
          xs: 12,
          newLine: true
        },

        _revokeSelected: {
          type: "sendTo",
          label: "Ausgewähltes Profil widerrufen",
          command: "revokeProfile",
          showProcess: true,
          timeout: 60000,
          confirm: "Ausgewähltes Profil wirklich widerrufen?",
          jsonData: "{\"profileName\":\"${data._revokeProfile}\"}",
          alsoDependsOn: ["_revokeProfile"]
        },

        _revokeByName: {
          type: "sendTo",
          label: "Profil nach Name widerrufen (Profilname oben)",
          command: "revokeProfile",
          showProcess: true,
          timeout: 60000,
          jsonData: "{\"profileName\":\"${data._profileName}\"}",
          alsoDependsOn: ["_profileName"]
        }
      }
    },

    support: {
      type: "panel",
      label: "Support (optional)",
      items: {
        _sInfo: {
          type: "staticText",
          text: "Support‑Zugang ist OPT‑IN. Wenn aktiviert, wird ein dedizierter Peer (PublicKey) in WireGuard eingetragen. Der Kunde kann ihn jederzeit deaktivieren; optional mit Ablaufzeit. Ziel: kein versteckter Dauerzugang."
        },

        supportPeerName: { type: "text", label: "Support‑Peer‑Name", sm: 6, md: 4, placeholder: "nexowatt-support" },
        supportPeerPublicKey: { type: "text", label: "Public Key (Support/Vendor)", sm: 12, md: 8, placeholder: "<WireGuard PublicKey einfügen>" },
        supportExpiryMinutes: { type: "number", label: "Ablaufzeit (Minuten, 0 = keine)", sm: 6, md: 4, min: 0, max: 10080, step: 1 },

        _supportPassword: { type: "password", label: "Passwort (optional → PSK abgeleitet)", sm: 6, md: 4, placeholder: "leer lassen = zufällige PSK" },

        _enableSupport: {
          type: "sendTo",
          label: "Support‑Zugang aktivieren",
          command: "enableSupportProfile",
          showProcess: true,
          timeout: 60000,
          confirm: "Support‑Zugang jetzt aktivieren? (Peer wird hinzugefügt/rotiert)",
          jsonData: "{\"password\":\"${data._supportPassword}\",\"expiresMinutes\":\"${data.supportExpiryMinutes}\"}",
          alsoDependsOn: ["supportPeerPublicKey", "supportPeerName", "supportExpiryMinutes", "_supportPassword"]
        },

        _disableSupport: {
          type: "sendTo",
          label: "Support‑Zugang deaktivieren",
          command: "disableSupportProfile",
          showProcess: true,
          timeout: 60000,
          confirm: "Support‑Zugang deaktivieren und Peer entfernen?"
        },

        _supportStates: {
          type: "staticText",
          text: "Aktueller Support‑Status (aus ioBroker‑States):"
        },

        _supportActive: { type: "state", label: "Support aktiv", oid: "support.active", control: "text", xs: 12, newLine: true },
        _supportExpires: { type: "state", label: "Ablaufzeit (timestamp)", oid: "support.expiresAt", control: "text", xs: 12, newLine: true },

        _supportStatus: {
          type: "textSendTo",
          label: "Support‑Peer Status (aus WG‑Konfiguration)",
          command: "supportStatus",
          onLoaded: false,
          copyToClipboard: true,
          container: "text"
        },

        _supportOut: {
          type: "state",
          label: "Support‑Ausgabe (Template)",
          oid: "support.lastOutputHtml",
          control: "html",
          xs: 12,
          newLine: true
        }
      }
    }
  }
}
